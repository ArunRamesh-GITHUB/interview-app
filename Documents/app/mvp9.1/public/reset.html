<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset your password</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fff;color:#0f172a}
    .wrap{max-width:420px;margin:10vh auto;padding:24px;border:1px solid #e5e7eb;border-radius:12px}
    input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;margin-bottom:12px}
    button{width:100%;padding:12px;border:0;border-radius:999px;background:#6366f1;color:#fff;font-weight:600;cursor:pointer}
    .muted{color:#64748b;font-size:12px}
    .ok{color:#16a34a;margin-top:8px}
    .err{color:#dc2626;margin-top:8px}
  </style>
  <!-- Supabase JS (browser) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <h2 style="margin-top:0">Reset your password</h2>
    <p class="muted">This page is opened from the email link. Set your new password below.</p>
    <input id="pw1" type="password" placeholder="New password (min 8)" />
    <input id="pw2" type="password" placeholder="Repeat new password" />
    <button id="saveBtn">Save new password</button>
    <div id="msg" class="muted"></div>
  </div>

  <script>
    (async () => {
      // Use your project values (the anon key is safe in the browser)
      const SUPABASE_URL = "{{SUPABASE_URL}}".replace("{{SUPABASE_URL}}", "");
      const SUPABASE_ANON_KEY = "{{SUPABASE_ANON_KEY}}".replace("{{SUPABASE_ANON_KEY}}", "");

      // We inject real values at runtime by reading from window.env-like replacement:
      const urlFromServer = (await fetch("/api/health").then(()=>true).catch(()=>false)) ? true : false;

      // Fallback: embed values via server-side string replace at build time if you prefer.
      const url = SUPABASE_URL || (window.SUPABASE_URL || "");
      const key = SUPABASE_ANON_KEY || (window.SUPABASE_ANON_KEY || "");
      const supabase = window.supabase.createClient(url, key);

      // Ensure the magic token in the URL is processed so updateUser will work
      // In v2, the client reads the hash on load; just touching getSession helps settle state.
      await supabase.auth.getSession();

      const msg = document.getElementById("msg");
      const saveBtn = document.getElementById("saveBtn");
      const pw1 = document.getElementById("pw1");
      const pw2 = document.getElementById("pw2");

      saveBtn.addEventListener("click", async () => {
        try {
          saveBtn.disabled = true;
          msg.className = "muted"; msg.textContent = "Updating...";
          if (!pw1.value || pw1.value.length < 8) throw new Error("Password must be at least 8 characters.");
          if (pw1.value !== pw2.value) throw new Error("Passwords do not match.");

          const { data: sessionData } = await supabase.auth.getSession();
          if (!sessionData?.session) throw new Error("Invalid or expired link. Open this page from the email link again.");

          const { error } = await supabase.auth.updateUser({ password: pw1.value });
          if (error) throw error;

          msg.className = "ok";
          msg.textContent = "Password updated. You can now close this page and login.";
        } catch (e) {
          msg.className = "err";
          msg.textContent = e.message || "Failed to update password.";
        } finally {
          saveBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
